## 『jqクックブック』 本文訂正および別解

### 訂正

#### N10（p. 11）

誤：次の実行例では、で0から15の数値を生成し、[ 数値, 16 進文字列 ] を出力します。

正：次の実行例では、`range`で0から15の数値を生成し、[ 数値, 16 進文字列 ] を出力します。

2023年4月2日


### 別解

#### A06 配列の組み合わせを取る

`map`で自ら組まずとも、`combinations`という立派なビルトイン関数がありました。作者本人も前作の7.2.5節（pp. 139-141）で紹介していて忘れていました。

`combinations`で実装すれば、記載の例外は次のようになります。

```
$ echo '[ [1, 2, 3], ["a", "b"] ]' | jq -c '[ combinations ]'
[[1,"a"],[1,"b"],[2,"a"],[2,"b"],[3,"a"],[3,"b"]]

$ echo '[ ["焼肉", "とんかつ", "鯖みそ"], ["定食", "丼"] ]' | jq -c '[ combinations ] | map(join(""))'
["焼肉定食","焼肉丼","とんかつ定食","とんかつ丼","鯖みそ定食","鯖みそ丼"]
```

ビルトインは`jq`で組まれています。[ソース](https://github.com/stedolan/jq/blob/master/src/builtin.jq)は次の通りです。

```
def combinations:
    if length == 0 then [] else
        .[0][] as $x
          | (.[1:] | combinations) as $y
          | [$x] + $y
    end;
```

再帰で来ましたか。完敗です。

2023年3月28日



#### F01 九九の表

掲載した`kuku`でも動作しますが、外側のループは`foreach`を介さず`range`だけでも書けます。こちらの方が簡潔です。改定版のコードは次の通りです。

```
def kuku2:
    tonumber as $n |                                     # ここは同じ
    ($n * $n | tostring | length + 1) as $width |        # ここも同じ
    range(1; $n+1) |
    [ 
        . * range(1; $n+1) |
        tostring |
        STRING::rjust($width; " ")
    ] |
    join("");
```

それよりも、ビルトイン関数の`combinations`の方が早いです。関数には`n`を指定することで入力配列のn回の繰り返しをするバージョンもあります。

```
$ jq -nc '[ range(1; 10) ] | [ combinations(2) | .[0]*.[1] ]'
[1,2,3,4,5,6,7,8,9,2,4,6,8,10,12,14,16,18,3,6,9,12,15,18,21,24,27,
 4,8,12,16,20,24,28,32,36,5,10,15,20,25,30,35,40,45,6,12,18,24,30,36,42,48,54,
 7,14,21,28,35,42,49,56,63,8,16,24,32,40,48,56,64,72,9,18,27,36,45,54,63,72,81]
```

しまった。勉強不足だった。

2023年3月28日